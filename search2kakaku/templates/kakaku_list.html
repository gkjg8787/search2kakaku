{% extends "base.html" %}

{% block head %}
    <title>kakakuscrapingのURL登録状況</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        .error-container {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }
        .error-toggle {
            display: inline-block;
            margin-left: 0.75rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.9rem;
            background: transparent;
            color: #721c24;
            border: 1px solid rgba(114,28,36,0.15);
            border-radius: 4px;
            cursor: pointer;
        }
        .error-toggle:focus {
            outline: 2px solid rgba(0,123,255,0.25);
        }
        .error-list.collapsed {
            display: none;
        }
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .product-table th, .product-table td {
            border: 1px solid #dee2e6;
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
        }
        .product-table thead th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
        }
        .product-table tbody tr:nth-of-type(odd) {
            background-color: #f8f9fa;
        }
        .product-table img {
            max-width: 100px;
            height: auto;
            border-radius: 4px;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .no-results {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        .btn-register {
            display: inline-block;
            padding: 6px 12px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
            background-color: #28a745;
            border-color: #28a745;
            border-radius: 4px;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
        }
        .button-like {
            display: inline-block;
            padding: 8px 12px;
            margin-bottom: 15px;
            background-color: #4CAF50; /* 緑色 */
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
        }

        @media (prefers-color-scheme: dark) {
            body {
                color: #e0e0e0;
                background-color: #121212;
            }
            .container {
                background-color: #1e1e1e;
                box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            }
            h1 {
                color: #e0e0e0;
                border-bottom-color: #444;
            }
            .error-container {
                background-color: #412022;
                color: #f8d7da;
                border-color: #5c2e33;
            }
            .error-toggle {
                color: #f8d7da;
                border-color: rgba(248,215,218,0.15);
            }
            .product-table th, .product-table td {
                border-color: #444;
            }
            .product-table thead th {
                background-color: #333;
                color: #e0e0e0;
            }
            .product-table tbody tr:nth-of-type(odd) {
                background-color: #2c2c2c;
            }
            a { color: #6cb2ff; }
            .no-results, [style*="color:#6c757d"] { color: #888; }
            select, [style*="color:#495057"] {
                background-color: #333;
                color: #e0e0e0;
                border-color: #555;
            }
            .btn-register {
                background-color: #218838;
                border-color: #1e7e34;
            }
        }
    </style>
{% endblock %}
{% block body %}

<div class="container">
    <h1>kakakuscrapingのURL登録状況</h1>
    <nav>
        <a href="{{ url_for('url_list') }}" class="button-like">URL一覧へ</a>
    </nav>
    {% if error_msgs %}
    <div class="error-container">
        <strong>エラーが発生しました:</strong>
        <button type="button" class="error-toggle" aria-expanded="false" aria-controls="error-list">エラーを表示</button>
        <div id="error-list" class="error-list collapsed" hidden>
            <ul>
                {% for msg in error_msgs %}
                <li>{{ msg }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    {% if results %}
    <div style="margin-top:1rem; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem;">
        <label for="active-filter" style="font-weight:600; color:#495057;">状態フィルター:</label>
        <select id="active-filter" name="active_filter" style="padding:6px 8px; border-radius:4px; border:1px solid #ced4da;">
            <option value="all" {% if active_filter is not defined or active_filter is none or active_filter == 'all' %}selected{% endif %}>全て</option>
            <option value="active" {% if active_filter == 'active' %}selected{% endif %}>active</option>
            <option value="inactive" {% if active_filter == 'inactive' %}selected{% endif %}>inactive</option>
        </select>
    </div>
    <table class="product-table">
        <thead>
            <tr>
                <th>URLID</th>
                <th>URL</th>
                <th>アイテムID</th>
                <th>アイテム名</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
                {% set active_val = (result.is_active if result.is_active is defined else '') %}
                {% if result["items"] and result["items"] | length > 0 %}
                    {% for item in result["items"] %}
                    <tr data-url-active="{{ active_val }}">
                        <td>{{ result.url_id if result.url_id is not none else '' }}</td>
                        <td><a href="{{ result.url }}" target="_blank" rel="noopener noreferrer">{{ result.url }}</a></td>
                        <td>
                            {% if to_link %}
                            <a href="{{ item.item_id | tokakaku_link }}" target="_blank" rel="noopener noreferrer">{{ item.item_id }}</a>
                            {% else %}
                            {{ item.item_id }}
                            {% endif %}
                        </td>
                        <td>{{ item.name }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr data-url-active="{{ active_val }}">
                        <td>{{ result.url_id if result.url_id is not none else '' }}</td>
                        <td><a href="{{ result.url }}" target="_blank" rel="noopener noreferrer">{{ result.url }}</a></td>
                        <td style="color:#6c757d;">(アイテムなし)</td>
                        <td>
                            <a href="{{ url_for('add_url_to_kakaku_form')}}?url={{ result.url | urlencode }}" class="btn-register">登録</a>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <div class="no-results">
            <p>表示するアイテムがありません。</p>
        </div>
    {% endif %}
</div>

<script>
// Error list toggle: progressive enhancement, accessible toggle
document.addEventListener('DOMContentLoaded', function () {
    var toggles = document.querySelectorAll('.error-toggle');
    toggles.forEach(function (btn) {
        var targetId = btn.getAttribute('aria-controls');
        var target = document.getElementById(targetId);
        if (!target) return;
        // ensure initial collapsed state
        btn.setAttribute('aria-expanded', 'false');
        target.hidden = true;
        target.classList.add('collapsed');

        btn.addEventListener('click', function () {
            var expanded = btn.getAttribute('aria-expanded') === 'true';
            if (expanded) {
                btn.setAttribute('aria-expanded', 'false');
                target.hidden = true;
                target.classList.add('collapsed');
                btn.textContent = 'エラーを表示';
            } else {
                btn.setAttribute('aria-expanded', 'true');
                target.hidden = false;
                target.classList.remove('collapsed');
                btn.textContent = 'エラーを閉じる';
            }
        });
    });

    // Active state filter: perform GET reload with `active_filter` param
    var filter = document.getElementById('active-filter');
    if (filter) {
        filter.addEventListener('change', function () {
            var val = filter.value; // 'all' | 'active' | 'inactive'
            var url = new URL(window.location.href);
            var params = url.searchParams;
            // set active_filter and remove legacy is_active if present
            params.set('active_filter', val);
            params.delete('is_active');
            // navigate to the new URL
            url.search = params.toString();
            window.location.href = url.toString();
        });
    }
});
</script>

{% endblock %}
